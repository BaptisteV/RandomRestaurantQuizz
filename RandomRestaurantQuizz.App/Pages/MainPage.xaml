<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="RandomRestaurantQuizz.App.MainPage"
             xmlns:controls="clr-namespace:RandomRestaurantQuizz.App;assembly=RandomRestaurantQuizz.App"
             xmlns:vm="clr-namespace:RandomRestaurantQuizz.App.ViewModels"
             xmlns:conv="clr-namespace:RandomRestaurantQuizz.App.ViewModels"
             x:DataType="vm:MainPageViewModel"
             Loaded="ContentPage_Loaded"
             Unloaded="ContentPage_Unloaded"
             Title="{Binding SearchLocation.Name}">

    <ContentPage.Resources>
        <conv:BoolToMaxLinesConverter x:Key="BoolToMaxLinesConverter"
                                      CollapsedLines="1"
                                      ExpandedLines="0" />
        <conv:RatingToColorConverter x:Key="RatingToColorConverter"
                                     BaseColor="Gold" />
    </ContentPage.Resources>

    <Grid MaximumWidthRequest="720"
          Background="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"></RowDefinition>
            <RowDefinition Height="72"></RowDefinition>
            <RowDefinition Height="72"></RowDefinition>
        </Grid.RowDefinitions>
        <ScrollView  Grid.Row="0">
            <VerticalStackLayout Spacing="4">
                <Grid>
                    <Label Text="{Binding Round.RestaurantName}"
                           HorizontalOptions="Start"
                           FontSize="Small" />

                    <Label Text="{Binding Round.Progress}"
                           HorizontalOptions="End"
                           FontSize="Small" />
                </Grid>

                <Grid x:Name="PhotoContainer">
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Tapped="TapGestureRecognizer_Tapped" />
                    </Grid.GestureRecognizers>
                    <Border BackgroundColor="#40000000"
                            Padding="4,0"
                            ZIndex="2"
                            Stroke="#40FFFFFF"
                            Opacity="0.8"
                            StrokeShape="RoundRectangle 4"
                            StrokeThickness="2"
                            HorizontalOptions="End"
                            VerticalOptions="Start">
                        <AbsoluteLayout HorizontalOptions="End">
                            <FlexLayout JustifyContent="Center">
                                <Label Text="{Binding Score}"
                                       FontSize="Large" />

                                <Label x:Name="ScoreDiffLabel"
                                       Text="{Binding ScoreDiff}"
                                       Opacity="1.0"
                                       FontSize="Medium" />
                            </FlexLayout>
                        </AbsoluteLayout>
                    </Border>
                    <Border Stroke="#40FFFFFF"
                            StrokeThickness="1"
                            Padding="4"
                            Margin="0,2"
                            StrokeShape="RoundRectangle 4">

                        <Image ZIndex="1"
                               HeightRequest="240"
                               Source="{Binding ImageSource}"
                               Aspect="AspectFit"
                               SemanticProperties.Description="Restaurant photo">
                        </Image>
                    </Border>
                </Grid>

                <CollectionView ItemsSource="{Binding Reviews}"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:VmReview">
                            <StackLayout>
                                <Border Stroke="#40FFFFFF"
                                        StrokeThickness="1"
                                        Padding="4"
                                        Margin="0,2"
                                        StrokeShape="RoundRectangle 4">
                                    <VerticalStackLayout>
                                        <VerticalStackLayout.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=BindingContext.ToggleReviewCommand}"
                                                                  CommandParameter="{Binding .}" />
                                        </VerticalStackLayout.GestureRecognizers>
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="{Binding AuthorName}"
                                                   FontAttributes="Bold"
                                                   VerticalTextAlignment="End"
                                                   FontSize="10" />

                                            <Label Text="{Binding RelativePublishTimeDescription}"
                                                   VerticalTextAlignment="End"
                                                   FontSize="10" />
                                        </HorizontalStackLayout>

                                        <Label Text="{Binding Text}"
                                               MaxLines="{Binding IsExpanded, Converter={StaticResource BoolToMaxLinesConverter}}"
                                               FontSize="14" />
                                    </VerticalStackLayout>
                                </Border>
                            </StackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <CollectionView ItemsSource="{Binding Reviews}"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:VmReview">
                            <VerticalStackLayout>
                                <VerticalStackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type CollectionView}}, Path=BindingContext.ToggleReviewCommand}"
                                                          CommandParameter="{Binding .}" />
                                </VerticalStackLayout.GestureRecognizers>
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding AuthorName}"
                                           FontAttributes="Bold"
                                           VerticalTextAlignment="End"
                                           FontSize="12" />

                                    <Label Text="{Binding RelativePublishTimeDescription}"
                                           VerticalTextAlignment="End"
                                           FontSize="11" />
                                </HorizontalStackLayout>

                                <Label Text="{Binding Text}"
                                       MaxLines="{Binding IsExpanded, Converter={StaticResource BoolToMaxLinesConverter}}"
                                       FontSize="14" />

                                <BoxView HeightRequest="1"
                                         Color="Gold"
                                         Opacity="0.5" 
                                         Margin="0,4"/>
                                
                            </VerticalStackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>
        <Border Grid.Row="1"
                x:Name="StarsContainer"
                Stroke="{Binding RatingInput, Converter={StaticResource RatingToColorConverter}}"
                StrokeThickness="2"
                Opacity="0.8"
                StrokeShape="RoundRectangle 8"
                HorizontalOptions="Center">
            <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="RatingPbInput_Tapped" />
            </Border.GestureRecognizers>
            <controls:StarRating ZIndex="2"
                                 StarSize="44"
                                 HorizontalOptions="Fill"
                                 Rating="{Binding RatingInput}">
            </controls:StarRating>
        </Border>

        <Button Grid.Row="2"
                x:Name="AnswerBtn"
                Text="{Binding RatingInputText}"
                SemanticProperties.Hint="Answer"
                Clicked="AnswerBtn_Clicked"
                HorizontalOptions="Fill"
                IsEnabled="false"
                FontSize="Medium"
                Background="{Binding RatingInput, Converter={StaticResource RatingToColorConverter}}">
        </Button>
    </Grid>

</ContentPage>
